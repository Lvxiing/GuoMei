<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cssl.mapper.OrdersMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.cssl.entity.Orders">
        <id column="order_id" property="id" />
        <result column="address_id" property="addressId" />
        <result column="pay_date" property="payDate" />
        <result column="order_time" property="orderTime" />
        <result column="order_total" property="total" />
        <result column="order_status" property="status" />
        <result column="order_no" property="orderNo" />
    </resultMap>
    <resultMap type="map" id="maps">
        <!-- column:数据库字段  property:实体类属性  -->
        <result column="order_id" property="id"/>
        <result column="goods_title" property="title"/>
        <result column="order_time" property="orderTime"/>
        <result column="order_total" property="total"/>
        <result column="order_status" property="status"/>
        <result column="order_no" property="orderNo"/>
        <result column="address_detail" property="address"/>
        <result column="address_name" property="userName"/>
    </resultMap>
    <!--后台查看订单详情-->
    <select id="orderDetail" resultType="map" parameterType="string">
        SELECT o.order_no,g.`goods_title`,s.`detail_num`,s.`detail_money`,g.`goods_main_img`
        FROM orders o
                 INNER JOIN order_detail s ON s.`order_id`=o.order_id
                 INNER JOIN   goods g ON g.`goods_id`=s.`goods_id`
        WHERE o.`order_no`=#{order_no}
    </select>
    <!--查询订单信息-->
    <select id="orderList" resultMap="maps" parameterType="map">
        SELECT  o.`order_id`,
        a.`address_name`,a.`address_detail`,
        o.`order_no`,o.`order_status`,
        o.`order_total`,o.`order_time`
        FROM orders o
        INNER JOIN address a ON a.`address_id`=o.`address_id`

        <trim prefix="where" prefixOverrides="and ||or">
            <if test="name !='null'and name !='' and name!=null ">
                and  a.`address_name` LIKE CONCAT(CONCAT('%',#{name}),'%')
            </if>
            <if test="orderNo !='null'and orderNo !='' and orderNo!=null ">
                and o.`order_no` LIKE CONCAT(CONCAT('%',#{orderNo}),'%')
            </if>
        </trim>
    </select>
    <!--根据订单号查询订单详情(用于修改回显)-->
    <select id="ByIdOrders" resultMap="maps" parameterType="string">
        SELECT DISTINCT o.`order_id`,
                        a.`address_name`,a.`address_detail`,
                        o.`order_no`,o.`order_status`,
                        o.`order_total`,o.`order_time`
        FROM orders o
                 INNER JOIN address a ON a.`address_id`=o.`address_id`
        where o.`order_no`=#{orderNo}
    </select>
    <!--修改订单状态-->
    <update id="updateStatus" parameterType="orders">
        UPDATE orders SET order_status=#{status} WHERE order_no=#{orderNo}
    </update>
    <!--删除订单-->
    <delete id="deleteOrder" parameterType="int">
        delete from orders where order_id=#{orderId}
    </delete>
    <!--计算本月订单数量和金额-->
    <select id="orderQuantity" resultType="map">
        SELECT COUNT(0) AS nums,IFNULL(SUM(order_total),0) AS money FROM orders
        WHERE  SUBSTR(order_time,6,2)=SUBSTR(CURDATE(),6,2)
    </select>
    <!--计算本月退单数量-->
    <select id="returnQuantity" resultType="map">
        SELECT COUNT(0) AS nums,IFNULL(SUM(order_total),0) AS money  FROM orders
        WHERE SUBSTR(order_time,6,2)=SUBSTR(CURDATE(),6,2) AND order_status=6
    </select>
    <!--计算本月订单实际金额-->
    <select id="orderAmount" resultType="double">
        SELECT IFNULL(SUM(order_total),0) AS money  FROM orders
        WHERE SUBSTR(order_time,6,2)=SUBSTR(CURDATE(),6,2) AND
            order_status IN (2,3,4,5)
    </select>
    <!--计算最近一周的订单金额-->
    <select id="weekOrderQuantity" resultType="map">
        SELECT  SUBSTR(order_time,1,10) AS times,IFNULL(SUM(order_total),0) AS money  FROM orders
        WHERE
            DATE_SUB(CURDATE(), INTERVAL 7 DAY) <![CDATA[ <= ]]> DATE(order_time)
        GROUP BY  SUBSTR(order_time,1,10)
    </select>
    <!--查询最近一周的实际金额-->
    <select id="weekOrderAmount" resultType="map">
        SELECT SUBSTR(order_time,1,10) AS times, IFNULL(SUM(order_total),0) AS money  FROM orders
        WHERE order_status IN (2,3,4,5) AND
            DATE_SUB(CURDATE(), INTERVAL 7 DAY) <![CDATA[ <= ]]>  DATE(order_time)
        GROUP BY  SUBSTR(order_time,1,10)
    </select>
    <!--查询最近一周的退款金额-->
    <select id="weekReturnQuantity" resultType="map">
        SELECT SUBSTR(order_time,1,10) AS times, IFNULL(SUM(order_total),0) AS money  FROM orders
        WHERE order_status=6 AND
            DATE_SUB(CURDATE(), INTERVAL 7 DAY) <![CDATA[ <= ]]> DATE(order_time)
        GROUP BY  SUBSTR(order_time,1,10)
    </select>
    <!--查询最近一周的未付金额-->
    <select id="weekUnpaidAmount" resultType="map">
        SELECT SUBSTR(order_time,1,10) AS times, IFNULL(SUM(order_total),0) AS money  FROM orders
        WHERE order_status=1 AND
            DATE_SUB(CURDATE(), INTERVAL 7 DAY) <![CDATA[ <= ]]> DATE(order_time)
        GROUP BY  SUBSTR(order_time,1,10)
    </select>

</mapper>
